import { Meta } from '@storybook/blocks';

import * as LottieStories from './Lottie.stories.svelte';
import CompositionMarkerImage from './assets/marker.jpg?url';

<Meta of={LottieStories} />

# Lottie

The `Lottie` component uses the [dotLottie-web](https://developers.lottiefiles.com/docs/dotlottie-player/dotlottie-web/) library to render Lottie animations.

## How to prepare Lottie files

[LottieFiles](https://lottiefiles.com/) is the official platform for creating and editing Lottie animations. The free version of LottieFiles has limited features, so [Bodymovin](https://exchange.adobe.com/apps/cc/12557/bodymovin) remains a popular, free way to export Lottie animations as JSON files. 

[dotLottie](https://dotlottie.io/) is another common format for Lottie files. This format bundles the Lottie JSON file and any associated assets, such as images and fonts, into a single compressed file with the extension `.lottie`.

This `Lottie` component is flexible and supports both `dotLottie` and JSON Lottie files. For best performance it is recommended that you convert your Lottie JSON file into a `.zip` file by following these steps:

1. Export your Lottie animation as a JSON file using [Bodymovin](https://exchange.adobe.com/apps/cc/12557/bodymovin) or another Lottie exporter.
2. Use the [LottieFiles converter](https://lottiefiles.com/tools/lottie-to-dotlottie) to convert the JSON file into a `.lottie` file. 
3. Change the file extension to `.zip` from `.lottie`. This ensures full compatibility with the Reuters graphics publisher while maintaining the benefits of dotLottie format's compression and optimisation.

## Basic demo

To use the `Lottie` component, import it and provide the Lottie animation source. The height of the container defaults to `100lvh`, but you can adjust this to any valid CSS height value such as `1200px` or `200lvh` with the `height` prop.

**Use `lvh` or `svh` units instead of `vh`** as [these units](https://www.w3.org/TR/css-values-4/#large-viewport-size) are more reliable on mobile and other devices where elements such as the address bar appear and disappear and affect the height.

If importing the Lottie file directly into a Svelte component, make sure to append **?url** to the import statement (see example below). This ensures that the file is treated as a URL.

> ðŸ’¡TIP: Set `showDebugInfo` prop to `true` to display information about the component state.

[Demo](?path=/story/components-graphics-scrollerlottie--demo)


```svelte
<script lang="ts">
  import { Lottie } from '@reuters-graphics/graphics-components';

  // Import Lottie file
  import MyLottie from './lottie/my-lottie.zip?url'; // Append **?url** to the file path
</script>

<Lottie src={MyLottie} autoplay={true} showDebugInfo={true} />
```

## Using with ArchieML

With the graphics kit, you'll likely get your text and prop values from an ArchieML doc...

```yaml
# ArchieML doc
[blocks]
  type: lottie

  # Lottie file stored in `src/statics/lottie/` folder
  src: lottie/LottieFile.zip
  autoplay: true
  loop: true
  showDebugInfo: true
[]
```

... which you'll parse out of a ArchieML block object before passing to the `Lottie` component.

```svelte
<script lang="ts">
  import { Lottie } from '@reuters-graphics/graphics-components';

  // Graphics kit only
  import { assets } from '$app/paths'; // ðŸ‘ˆ If using in the graphics kit...
  import { truthy } from '$utils/propValidators'; // ðŸ‘ˆ If using in the graphics kit...
</script>

{#each content.blocks as block}
  <!-- Inside the content.blocks for loop... -->
  {#if block.type == 'lottie'}
    <Lottie
      src={`${assets}/${block.src}`}
      autoplay={truthy(block.autoplay)}
      loop={truthy(block.loop)}
      showDebugInfo={truthy(block.showDebugInfo)}
    />
  {/if}
{/each}
```

## Playing a segment

 The `Lottie` component can play a specific segment of the Lottie animation using the `segment` prop. The `segment` prop expects an array of two numbers representing the start and end frames of the segment.

[Demo](?path=/story/components-graphics-scrollerlottie--segment)

With the graphics kit, you'll likely get your text and prop values from an ArchieML doc...

```yaml
# ArchieML doc
[blocks]
  type: lottie
  src: LottieFile.zip
  [.segment]
    start: 0
    end: 20
  []
  :end
[]
```

... which you'll parse out of a ArchieML block object before passing to the `Lottie` component.

```svelte
<script lang="ts">
  import { Lottie } from '@reuters-graphics/graphics-components';
  import { assets } from '$app/paths';
</script>

{#each content.blocks as block}
  <!-- Inside the content.blocks for loop... -->
  {#if block.type == 'lottie'}
    <Lottie
      src={`${assets}/animations/${block.src}`}
      segment={[block.segment.start, block.segment.end]}
      autoplay
      loop
      showDebugInfo
    />
  {/if}
{/each}
```

## Markers

 The `Lottie` component can also play a specific portion of the Lottie animation using markers set in [AfterEffects](https://helpx.adobe.com/in/after-effects/using/layer-markers-composition-markers.html).

The list of available markers, which can be passed into the `marker` prop, can be found in the debug info box that appears when `showDebugInfo` is set to `true`.

When setting markers in AfterEffects, ensure that the **Comment** section of the Composition Marker contains only the name of your marker:

<img src={CompositionMarkerImage} alt="Composition Marker Dialog" />

[Demo](?path=/story/components-graphics-scrollerlottie--marker)

```svelte
<script lang="ts">
  import { Lottie } from '@reuters-graphics/graphics-components';

  // Import Lottie file
  import MyLottie from './lottie/my-lottie.zip?url'; // Append **?url** to the file path
</script>

<Lottie src={MyLottie} marker="myMarker"
/>
```

## Switching themes

[Lottie Creator](https://lottiefiles.com/theming) allows you to define multiple color themes for your animation. You can switch between these themes using the `theme` prop.

Available themes can be found in the debug info when `showDebugInfo` prop is enabled.

With the graphics kit, you'll likely get your text and prop values from an ArchieML doc...

```yaml
# ArchieML doc
[blocks]
  type: lottie
  src: LottieFile.zip
  theme: myTheme
  :end
[]
```

... which you'll parse out of a ArchieML block object before passing to the `Lottie` component.

```svelte
<script lang="ts">
  import { Lottie } from '@reuters-graphics/graphics-components';
  import { assets } from '$app/paths';
</script>

{#each content.blocks as block}
  <!-- Inside the content.blocks for loop... -->
  {#if block.type == 'lottie'}
    <Lottie
      src={`${assets}/animations/${block.src}`}
      theme={block.theme}
      autoplay
      loop
      showDebugInfo
    />
  {/if}
{/each}
```

It is also possible to switch themes dynamically based on the `progress` prop by binding a variable to it.

[Demo](?path=/story/components-graphics-scrollerlottie--themes)

```svelte
<script lang="ts">
  import { Lottie } from '@reuters-graphics/graphics-components';
  // make a folder named 'data' and place the .zip lottie file inside it
  // append ?url to the import statement
  import LottieSrc from './data/lottie-example.zip?url';

  let progress = $state(0);
</script>

<Lottie
  src={LottieSrc}
  bind:progress
  themeId={progress < 0.33 ? 'water'
  : progress < 0.66 ? 'air'
  : 'earth'}
  autoplay
  showDebugInfo
/>
```

## With ScrollerBase

The `Lottie` component can be used in conjunction with the `ScrollerBase` component to create a more complex scrolling experience. The `ScrollerBase` component provides a scrollable container that can hold the `Lottie` component as a background.

```svelte
<script lang="ts">
  import { Lottie } from '@reuters-graphics/graphics-components';
  // make a folder named 'data' and place the .zip lottie file inside it
  // append ?url to the import statement
  import LottieSrc from './data/lottie-example.zip?url';

  // Pass `progress` as `videoPercentage` to Lottie
  let progress = $state(0);
</script>

<ScrollerBase bind:progress query="div.step-foreground-container">
  {#snippet backgroundSnippet()}
    <!-- Pass bindable prop `progress` as `progress` -->
    <div class="lottie-container">
      <Lottie src={LottieSrc} {progress} showDebugInfo />
    </div>
  {/snippet}
  {#snippet foregroundSnippet()}
    <!-- Add custom foreground HTML or component -->
    <div class="step-foreground-container">
      <h3 class="text-center">Step 1</h3>
    </div>
    <div class="step-foreground-container">
      <h3 class="text-center">Step 2</h3>
    </div>
    <div class="step-foreground-container">
      <h3 class="text-center">Step 3</h3>
    </div>
  {/snippet}
</ScrollerBase>

<style lang="scss">
  .lottie-container {
    width: 100%;
    height: 100lvh;
  }

  .step-foreground-container {
    height: 100lvh;
    width: 50%;
    padding: 1em;
    margin: auto;

    h3 {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: white;
    }
  }
</style>
```

## With foregrounds

The `Lottie` component can also be used to display captions or even components, such as `Headline` or ai2svelte files, as foregrounds at specific times in the animation. To do so, add LottieForeground components as children of the Lottie component.

[Demo](?path=/story/components-graphics-scrollerlottie--with-foregrounds)

With the graphics kit, you'll likely get your text and prop values from an ArchieML doc...

```yaml
# ArchieML doc
[blocks]
  type: lottie
  src: LottieFile.zip

  # Array of foregrounds
  [.foregrounds]
    startFrame: 0 # When in the animation to start showing the foreground
    endFrame: 50 # When to stop showing the foreground
	type: text
	{.foregroundProps}
		text: Some text for the foreground
	{}

	startFrame: 50 # When in the animation to start showing the foreground
    endFrame: 100 # When to stop showing the foreground
	type: component
	{.foregroundProps}
		componentType: Headline
		hed: Some headline text
		dek: Some deck text
		[.authors]
			* Jane Doe
			* John Smith
		[]
	{}
  []
  :end

[]
```

... which you'll parse out of a ArchieML block object before passing to the `Lottie` component.

```svelte
<script lang="ts">
  import {
    Lottie,
    LottieForeground,
  } from '@reuters-graphics/graphics-components';
  import { assets } from '$app/paths';

  const Components = $state({
    Headline,
    Video,
  });
</script>

{#each content.blocks as block}
  <!-- Inside the content.blocks for loop... -->
  {#if block.type == 'lottie'}
    <Lottie
      src={`${assets}/animations/${block.src}`}
      theme={block.theme}
      autoplay
      loop
      showDebugInfo
    >
      {#each block.foregrounds as foreground}
        {#if foreground.type == 'text'}
          <LottieForeground
            endFrame={parseInt(foreground.endFrame)}
            startFrame={parseInt(foreground.startFrame)}
            text={foreground.foregroundProps.text}
          />
        {:else if foreground.type == 'component'}
          {@const Component =
            Components[foreground.foregroundProps.componentType]}
          <LottieForeground
            endFrame={parseInt(foreground.endFrame)}
            startFrame={parseInt(foreground.startFrame)}
          >
            <Component {...foreground.foregroundProps} />
          </LottieForeground>
        {/if}
      {/each}
    </Lottie>
  {/if}
{/each}
```
