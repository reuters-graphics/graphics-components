import { Meta } from '@storybook/blocks';

import * as ScrollyVideoStories from './ScrollyVideo.stories.svelte';
 
<Meta of={ScrollyVideoStories} />

# ScrollyVideo

The `ScrollyVideo` component creates interactive video experiences that respond to user scrolling. It is built on top of [ScrollyVideo.js](https://scrollyvideo.js.org/) and is designed to work seamlessly with Svelte.

## Basic demo

To use the `ScrollyVideo` component, import it and provide the video source. Set the `height` prop to any valid CSS height value such as `1200px`, `50vh`, or `500svh` to set the scroll height.

[Demo](?path=/story/components-graphics-scrollyvideo--demo)

```svelte
<script lang="ts">
  import { ScrollyVideo } from '@reuters-graphics/graphics-components';
</script>

<ScrollyVideo
  src='my-video.mp4'
  height="500svh" 
/>
```

## Optimising videos
When using the `ScrollyVideo` component, minimise the video file size and ensure that the video is encoded in a format that is widely supported across browsers. Videos encoded at higher frames per second (FPS) are bound to crash on phone devices, so 24 FPS is recommended. 

> ðŸ’¡**TIP:** Set the `showDebugInfo` prop to `true` to see video encoding information

To optimise your video for the web, you can use `ffmpeg` to convert the video to a suitable format. Here is an example terminal command that converts a video to H.264 format with a resolution of 720p and a frame rate of 24 FPS:

```bash
npx ffmpeg -y -i <input_video_src>.mp4 -c:v libx264 -movflags faststart -crf 20 -r 24 -vf scale=720:-1 -profile:v high -preset veryslow -level:v 4.1 -color_primaries 1 -color_trc 1 -colorspace 1 -an <output_video>.mp4
```

Adjust the `-crf` value to control the quality. Lower `-crf` value means higher quality, with 20 being a generally good balance. See [Testing Media Capabilities](https://cconcolato.github.io/media-mime-support/mediacapabilities.html) for more.


## Responsive videos

To show different videos based on the screen width, use the `ScrollyVideo` component with conditional logic that uses a different video source depending on the [window width](https://svelte.dev/docs/svelte/svelte-window).

[Demo](?path=/story/components-graphics-scrollyvideo--responsive-videos)

```svelte
<script lang="ts">
  import { ScrollyVideo } from '@reuters-graphics/graphics-components';

  let width = $state(0);
</script>

<svelte:window bind:innerWidth={width} />

{#if width < 600}
  <!-- Video with aspect ratio 9:16 for window width smaller than 600px -->
  <ScrollyVideo
    src="my-video-sm.mp4"
    height="500svh"
  />
{:else if width < 1200}
  <!-- Video with aspect ratio 1:1 for window width between 600px and 1200px -->
  <ScrollyVideo
    src= "my-video-md.mp4"
    height="500svh"
  />
{:else}
  <!-- Video with aspect ratio 16:9 for window width above 1200px -->
  <ScrollyVideo
    src="my-video-lg.mp4"
    height="500svh"
  />
{/if}
```

## Embeds

Scrollytelling does not work in iframes. If the prop `embedded` is set to `true`, the video will be rendered as a regular video instead. By default, the video element has the properties `loop`, `muted`, and `playsinline` and `controls`. To customise the video properties, use the `embeddedProps` prop to render the embed video.  

To use a different video for the embedded version, pass its source to the `embeddedSrc` prop. If `embeddedSrc` is not provided, the component will use the `src` prop. 

> ðŸ’¡**TIP:** One way to recreate the ScrollyVideo experience for embeds is to record the desktop screen with [Scroll Capture](https://chromewebstore.google.com/detail/scroll-capture/egmhoeaacclmanaimofoooiamhpkimkk?hl=en) while scrollying through the video and use that video instead.

[Demo](?path=/story/components-graphics-scrollyvideo--embed)

```svelte
<script lang="ts">
  import { ScrollyVideo } from '@reuters-graphics/graphics-components';
</script>

<!-- Optionally pass `embeddedSrc` and `embeddedProps` -->
<ScrollyVideo
  embedded={true}
  src='my-video.mp4'
  embeddedSrc='my-video-embedded.mp4'
  embeddedProps={{ autoplay: true }} 
/>
```

## Autoplay

The `autoplay` option combines the autoplay and scrollytelling experience. If set to `true`, the video will start playing automatically when the component is mounted, but switch to scrollytelling when the user starts scrolling. The scroll height is calculated based on how much of the video remains, which means that if the user lets the video autoplay to near the end, the user would only have to scroll through a small height to get to the end. If the user lets the video autoplay to the end, there will be no scrolling effect.

[Demo](?path=/story/components-graphics-scrollyvideo--autoplay)

```svelte
<script lang="ts">
  import { ScrollyVideo } from '@reuters-graphics/graphics-components';
</script>

<ScrollyVideo
  src="my-video.mp4" 
  autoplay={true}
/>
```

## Time-based text foregrounds with ArchieML

The `ScrollyVideo` component can also be used to display text as foregrounds at specific times in the video. To do so, use the `ScrollyVideoForeground` component.

[Demo](?path=/story/components-graphics-scrollyvideo--archie-ml-foregrounds)

With the graphics kit, you'll likely get your text and prop values from an ArchieML doc...

```yaml
# ArchieML doc

# Headline
hed: The Alps
[authors]
 * Jane Doe
[]
publishTime: 2020-01-01T00:00:00Z
startTime: 0 # When in the video to start showing the headline
endTime: 2 # When to stop showing the headline

[blocks]
  type: scrolly-video
  id: alps-scrolly
  src: videos/alps.mp4
  height: 800svh

  # Array of foregrounds
  [.foregrounds]
    startTime: 3 # When in the video to start showing the foreground
    endTime: 7 # When to stop showing the foreground
    width: normal # text container width
    position: bottom center # Position of the text. Optional; defaults to 'center center'. Must be a combination of `top/bottom/center center/left/right`
    backgroundColour: rgba(0, 0, 0, 0.8) # Optional; defaults to white
    text: #### The Alps
    
    The Alps stretch across eight countries: France, Switzerland, Italy, Monaco, Liechtenstein, Austria, Germany, and Slovenia, covering about 1,200 kilometers (750 miles).

    :end

    startTime: 9
    endTime: 12
    width: normal
    position: bottom center
    backgroundColour: rgba(0, 0, 0, 0.8)
    text: Mont Blanc, standing at 4,809 meters (15,777 feet), is the highest peak in the Alps and Western Europe, though there's ongoing debate between France and Italy about exactly where the summit lies.

    :end

    startTime: 16
    endTime: 20
    width: normal
    position: bottom center
    backgroundColour: rgba(0, 0, 0, 0.8)
    text: #### History
    
    The Alps were formed around **65 million years** ago when the African and Eurasian tectonic plates collided, pushing the land upward.Over 14 million people live in the Alpine region, with tourism supporting approximately 120 million visitors annually.

    :end
  []
[]
```

... which you'll parse out of a ArchieML block object before passing to the `ScrollyVideo` and `ScrollyVideoForeground` components.

```svelte
<script lang="ts">
  import {
    ScrollyVideo,
    ScrollyVideoForeground
  } from '@reuters-graphics/graphics-components';
  import { assets } from '$app/paths'; // ðŸ‘ˆ If using in the graphics kit...
</script>

{#if block.type == 'scrolly-video'}
  <ScrollyVideo id={block.id} src={`${assets}/${block.src}}`} height={block.height}>

  <!-- You can wrap components, such as `Headline`, inside `ScrollyVideoForeground` and make them appear/disappear at specific times -->
    <ScrollyVideoForeground startTime={parseFloat(content.startTime)} endTime={parseFloat(content.endTime)}>
      <Headline
        hed={content.hed}  
        authors={content.authors}
        publishTime={content.publishedDate}
      />
    </ScrollyVideoForeground>

    <!-- Loop through foregrounds to add text blurbs that appear/disappear at specific times -->
    {#each block.foregrounds as foreground}
      <ScrollyVideoForeground
        startTime={parseFloat(foreground.startTime)}
        endTime={parseFloat(foreground.endTime)}
        width={foreground.width}
        position={foreground.position}
        backgroundColour={foreground.backgroundColour}
        text={foreground.text}
      />
    {/each}
  </ScrollyVideo>
{/if}
```


## Time-based component foregrounds with ArchieML

The `ScrollyVideo` component can also be used to display components, such as `Headline` or ai2svelte files, as foregrounds at specific times in the video. To do so, use the `ScrollyVideoForeground` component.

[Demo](?path=/story/components-graphics-scrollyvideo--component-archie-ml-foregrounds)

With the graphics kit, you'll likely get your text and prop values from an ArchieML doc...

```svelte
<script lang="ts">
  // Graphics kit only
  import { assets } from '$app/paths'; // ðŸ‘ˆ If using in the graphics kit...
  import { truthy } from '$utils/propValidators'; // ðŸ‘ˆ If using in the graphics kit...

  import {
    Headline,
    GraphicBlock,
    ScrollyVideo,
    Foreground,
  } from '@reuters-graphics/graphics-components';

  // Foreground ai2svelte components
  import Annotation1 from './ai2svelte/annotation1.svelte';
  import Annotation2 from './ai2svelte/annotation2.svelte';
  import Annotation3 from './ai2svelte/annotation3.svelte';
  import Annotation4 from './ai2svelte/annotation4.svelte';

  // Foreground ai2svelte graphics components
  const aiChartsForeground = {
    Annotation1,
    Annotation2,
    Annotation3,
    Annotation4,
  };

  let width = $state(1);
</script>

<svelte:window bind:innerWidth={width} />

{#snippet ScrollForeground()}
  <Foreground startTime={0} endTime={0.3}>
    <Headline
      class="custom-headline"
      hed="ScrollyVideo inside ScrollerBase"
      dek="This is a demo of ScrollyVideo inside ScrollerBase component."
      section={'Reuters Graphics'}
      authors={['Jane Doe']}
      publishTime={new Date('2020-01-01').toISOString()}
    />
  </Foreground>
  <Foreground startTime={0.3} endTime={2.2}>
    <GraphicBlock title="" description="" width="fluid">
      <Annotation1 />
    </GraphicBlock>
  </Foreground>
  <Foreground startTime={2.2} endTime={3.2}>
    <GraphicBlock title="" description="" width="fluid">
      <Annotation2 />
    </GraphicBlock>
  </Foreground>
  <Foreground startTime={3.2} endTime={4.5}>
    <GraphicBlock title="" description="" width="fluid">
      <Annotation3 />
    </GraphicBlock>
  </Foreground>
  <Foreground startTime={6.5} endTime={8}>
    <GraphicBlock title="" description="" width="fluid">
      <Annotation4 />
    </GraphicBlock>
  </Foreground>
{/snippet}

{#snippet ScrollVideo(height: string, VideoSrc: string)}
  <ScrollyVideo {height} src={VideoSrc} useWebCodecs={true} showDebugInfo>
    {@render ScrollForeground()}
  </ScrollyVideo>
{/snippet}

{#if width < 600}
  {@render ScrollVideo('800svh', `${assets}/videos/sm.mp4`)}
{:else if width < 1200}
  {@render ScrollVideo('800svh', `${assets}/videos/md.mp4`)}
{:else}
  {@render ScrollVideo('800svh', `${assets}/videos/lg.mp4`)}
{/if}

<style lang="scss">
  :global(.custom-headline *) {
    color: white;
  }

  :global(.scrolly-video-foreground) {
    filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.85));
  }
</style>
```


## Using with `ScrollerBase`

The `ScrollyVideo` component can be used inside the [ScrollerBase](?path=/story/components-graphics-scrollerbase--docs) component to add foreground content. This allows for more complex interactions and layouts, such as adding ai2svelte components in the foreground.

[Demo](?path=/story/components-graphics-scrollyvideo--scroller-base)

```svelte
<script lang="ts">
  import {
    Headline,
    GraphicBlock,
    ScrollyVideo,
    ScrollerBase,
  } from '@reuters-graphics/graphics-components';
  import AiMap from './ai2svelte/ai-chart.svelte';

  // ScrollerBase props
  let count = $state(1);
  let index = $state(0);
  let offset = $state(0);
  let progress = $state(0);
  let top = $state(0);
  let threshold = $state(0);
  let bottom = $state(1);
</script>

<div class="scroller-demo-container">
  <ScrollerBase
    {top}
    {threshold}
    {bottom}
    bind:count
    bind:index
    bind:offset
    bind:progress
    query="div.step-foreground-container"
    visible
  >
    {#snippet backgroundSnippet()}
      <!-- Add custom background HTML or component -->
      <div id="progress-bar">
        <p>
          Current step: <strong>{index + 1}/{count}</strong>
        </p>
        <progress value={(index + 1) / count}></progress>

        <p>Offset in current step</p>
        <progress value={offset}></progress>

        <p>Total progress</p>
        <progress value={progress}></progress>
      </div>

      <ScrollyVideo
        src={`src/components/ScrollyVideo/videos/goldengate.mp4`}
        height="100svh"
        trackScroll={false}
        videoPercentage={progress}
        objectFit="cover"
        showDebugInfo
        {embedded}
      />
    {/snippet}
    {#snippet foregroundSnippet()}
      <!-- Add custom foreground HTML or component -->
      <div class="step-foreground-container">
        <div class="fg-child-container">
          <Headline
            class="custom-headline"
            hed="ScrollyVideo inside ScrollerBase"
            dek="This is a demo of ScrollyVideo inside ScrollerBase component."
            section={'Reuters Graphics'}
            authors={['Jane Doe']}
            publishTime={new Date('2020-01-01').toISOString()}
          />
        </div>
      </div>
      <div class="step-foreground-container"><p>Step 2</p></div>
      <div class="step-foreground-container">
        <div class="fg-child-container">
          <GraphicBlock
            title="Earthquake in Haiti"
            description="The 7.2-magnitude earthquake struck at 8:29 a.m. EST, Aug. 14, 2021."
            notes="Note: A shakemap represents the ground shaking produced by an earthquake."
          >
            <AiMap />
          </GraphicBlock>
        </div>
      </div>
      <div class="step-foreground-container"><p>Step 4</p></div>
      <div class="step-foreground-container"><p>Step 5</p></div>
    {/snippet}
  </ScrollerBase>
</div>

<style lang="scss">
  @use '../../../scss/mixins' as mixins;

  #progress-bar {
    background-color: rgba(0, 0, 0, 0.8);
    position: absolute;
    z-index: 2;
    right: 0;
    padding: 1rem;

    progress {
      height: 6px;
      background-color: #ff000044; /* Background color of the entire bar */
    }

    progress::-webkit-progress-value {
      background-color: white;
      border-radius: 10px;
    }

    progress::-webkit-progress-bar {
      background-color: #444444;
      border-radius: 10px;
    }

    p {
      font-family: var(--theme-font-family-sans-serif);
      color: white;
      font-size: var(--theme-font-size-xs);
      padding: 0;
      margin: 0;
    }
  }

  #debugger {
    width: 100%;
    height: 100vh;
    background-color: hotpink;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      padding: 0;
      margin: 0;
    }
  }

  .step-foreground-container {
    height: 100vh;
    width: 100%;
    padding: 1em;
    position: relative;
    border: 1px solid red;

    .fg-child-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 100%;
    }

    p {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
      font-size: 2em;
      color: white;
      font-family: var(--theme-font-family-sans-serif);
    }
  }
</style>
```

## Advanced usecases

For advanced use cases such as looping a particular section of the video, or jumping to a specific time in the video, you can bind `scrollyVideo` prop and take benefits of methods such as `setVideoPercentage` or bindable methods such as `onReady` and `onChange`. This allows for fine-grained control over the video playback and interaction with the scroll position.

```js
scrollyVideo.setVideoPercentage(0.5, {
  jump: false,
  transitionSpeed: 12,
  easing: d3.easeLinear,
});
```

This will set the video to 50% progress, with a smooth transition at a playback rate of 12, using a linear easing function.
